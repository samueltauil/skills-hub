---
import Layout from '../../layouts/Layout.astro';
import skillsData from '../../data/skills.json';

// Define category metadata (icons and names)
const categoryMeta: Record<string, { name: string; icon: string }> = {
  'git-version-control': { name: 'Git & Version Control', icon: 'ðŸ”€' },
  'code-quality': { name: 'Code Quality & Refactoring', icon: 'âœ¨' },
  'documentation': { name: 'Documentation', icon: 'ðŸ“' },
  'diagrams': { name: 'Diagrams & Visualization', icon: 'ðŸ“Š' },
  'testing': { name: 'Testing', icon: 'ðŸ§ª' },
  'api-backend': { name: 'API & Backend', icon: 'ðŸ”Œ' },
  'frontend-ui': { name: 'Frontend & UI', icon: 'ðŸŽ¨' },
  'devops-cicd': { name: 'DevOps & CI/CD', icon: 'ðŸš€' },
  'security': { name: 'Security', icon: 'ðŸ”’' },
  'data-analytics': { name: 'Data & Analytics', icon: 'ðŸ“ˆ' },
  'office-documents': { name: 'Office Documents', icon: 'ðŸ“„' },
  'mcp-development': { name: 'MCP Development', icon: 'ðŸ”§' },
  'general': { name: 'General', icon: 'ðŸ“¦' }
};

export function getStaticPaths() {
  return skillsData.skills.map(skill => ({
    params: { id: skill.id },
    props: { skill }
  }));
}

interface SkillFile {
  path: string;
  name: string;
  content: string;
}

interface Props {
  skill: {
    id: string;
    name: string;
    description: string;
    shortDescription: string;
    category: string;
    author: string;
    license: string;
    source: {
      repo: string;
      repoName: string;
      path: string;
      branch: string;
    };
    files: SkillFile[];
    skillMdContent: string;
    tags: string[];
    featured: boolean;
    complexity: string;
    platforms: string[];
  };
}

const { skill } = Astro.props;
const category = categoryMeta[skill.category] || { name: skill.category, icon: 'ðŸ“' };
const baseUrl = import.meta.env.BASE_URL;

const complexityColors = {
  beginner: 'badge-success',
  intermediate: 'badge-warning',
  advanced: 'badge-primary'
};

const skillName = skill.name;
const skillPath = `.github/skills/${skillName}`;
const repoName = skill.source.repoName;

// Convert kebab-case to Title Case
function formatName(str: string): string {
  return str
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

const displayName = formatName(skillName);

// Get file extension for syntax highlighting
function getFileLanguage(filename: string): string {
  const ext = filename.split('.').pop()?.toLowerCase();
  const langMap: Record<string, string> = {
    'py': 'python',
    'js': 'javascript',
    'ts': 'typescript',
    'md': 'markdown',
    'json': 'json',
    'yaml': 'yaml',
    'yml': 'yaml',
    'sh': 'bash',
    'bash': 'bash',
    'css': 'css',
    'html': 'html',
    'tsx': 'typescript',
    'jsx': 'javascript'
  };
  return langMap[ext || ''] || 'text';
}

// Group files by directory
function groupFilesByDir(files: SkillFile[]): Map<string, SkillFile[]> {
  const groups = new Map<string, SkillFile[]>();
  
  for (const file of files) {
    const dir = file.path.includes('/') ? file.path.split('/').slice(0, -1).join('/') : '';
    if (!groups.has(dir)) {
      groups.set(dir, []);
    }
    groups.get(dir)!.push(file);
  }
  
  return groups;
}

const fileGroups = groupFilesByDir(skill.files);

// Generate the complete skill folder content for one-click copy
const allFilesJson = JSON.stringify(skill.files.map(f => ({
  path: `${skillPath}/${f.path}`,
  content: f.content
})), null, 2);
---

<Layout title={displayName} description={skill.description}>
  <section class="skill-detail">
    <div class="container">
      <nav class="breadcrumb">
        <a href={`${baseUrl}`}>Home</a>
        <span>/</span>
        <a href={`${baseUrl}skills/`}>Skills</a>
        <span>/</span>
        <span>{displayName}</span>
      </nav>

      <header class="skill-header">
        <div class="skill-title-row">
          <h1>{displayName}</h1>
          <span class={`badge ${complexityColors[skill.complexity]}`}>{skill.complexity}</span>
        </div>
        <p class="skill-description">{skill.description}</p>
        
        <div class="skill-meta">
          <a href={`${baseUrl}categories/${skill.category}/`} class="meta-item">
            <span class="meta-icon">{category.icon}</span>
            <span>{category.name}</span>
          </a>
          <a href={skill.source.repo} target="_blank" rel="noopener noreferrer" class="meta-item">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            <span>View Source</span>
          </a>
          <span class="meta-item license-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <span>{skill.license}</span>
          </span>
          <span class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            <span>{skill.files.length} files</span>
          </span>
        </div>
      </header>

      <!-- Attribution Banner -->
      <div class="source-tag">
        <a href={skill.source.repo} target="_blank" rel="noopener noreferrer" class="source-link">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          <span>{repoName}</span>
        </a>
        <a href={`${skill.source.repo}/tree/main/${skill.source.path}`} target="_blank" rel="noopener noreferrer" class="view-source-link">
          View source
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 3 21 3 21 9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
        </a>
      </div>

      <div class="skill-content">
        <div class="main-content">
          <!-- Installation Section -->
          <section class="content-section installation-section">
            <h2>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Installation
            </h2>
            
            <div class="install-card">
              <div class="install-header">
                <div class="install-info">
                  <p>Download and extract to your repository:</p>
                  <code class="install-path">{skillPath}/</code>
                </div>
                <div class="install-actions">
                  <button id="download-btn" class="download-btn" title="Download skill as ZIP">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span>Download ZIP</span>
                  </button>
                  <button id="copy-all-btn" class="copy-all-btn btn-secondary" title="Copy file contents to clipboard">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    <span>Copy Contents</span>
                  </button>
                </div>
              </div>
              
              <div class="install-note">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4M12 8h.01"/>
                </svg>
                <p>Extract the ZIP to <code>.github/skills/</code> in your repo. The folder name must match <code>{skillName}</code> for Copilot to auto-discover it.</p>
              </div>
            </div>
          </section>

          <!-- Files Section -->
          <section class="content-section files-section">
            <h2>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
              Skill Files ({skill.files.length})
            </h2>
            
            <div class="file-tree">
              {Array.from(fileGroups.entries()).map(([dir, files]) => (
                <div class="file-group">
                  {dir && (
                    <div class="folder-header">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                      </svg>
                      <span>{dir}/</span>
                    </div>
                  )}
                  {files.map((file) => (
                    <details class="file-item" data-path={file.path}>
                      <summary>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span class="file-name">{file.name}</span>
                        <span class="file-size">{(file.content.length / 1024).toFixed(1)} KB</span>
                        <button class="copy-file-btn" data-path={file.path} title="Copy file content">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                          </svg>
                        </button>
                      </summary>
                      <div class="file-content">
                        <pre><code class={`language-${getFileLanguage(file.name)}`}>{file.content}</code></pre>
                      </div>
                    </details>
                  ))}
                </div>
              ))}
            </div>
          </section>
        </div>

        <aside class="sidebar">
          <div class="sidebar-card">
            <h3>Quick Info</h3>
            <dl class="info-list">
              <dt>Author</dt>
              <dd>{skill.author}</dd>
              
              <dt>License</dt>
              <dd>{skill.license}</dd>
              
              <dt>Category</dt>
              <dd>{category?.name || skill.category}</dd>
              
              <dt>Complexity</dt>
              <dd class="capitalize">{skill.complexity}</dd>
              
              <dt>Install Path</dt>
              <dd><code>{skillPath}</code></dd>
            </dl>
          </div>

          <div class="sidebar-card">
            <h3>Tags</h3>
            <div class="tags-list">
              {skill.tags.map(tag => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          </div>

          <div class="sidebar-card">
            <h3>Related Skills</h3>
            <p class="text-secondary">Other skills in {category?.name || skill.category}</p>
            <ul class="related-list">
              {skillsData.skills
                .filter(s => s.category === skill.category && s.id !== skill.id)
                .slice(0, 3)
                .map(related => (
                  <li>
                    <a href={`${baseUrl}skills/${related.id}/`}>{related.name}</a>
                  </li>
                ))
              }
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </section>
</Layout>

<style>
  .skill-detail {
    padding: 2rem 0;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 2rem;
  }

  .breadcrumb a {
    color: var(--color-text-secondary);
  }

  .breadcrumb a:hover {
    color: var(--color-accent);
  }

  .skill-header {
    margin-bottom: 1.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  .skill-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .skill-title-row h1 {
    font-size: 2.5rem;
  }

  .skill-description {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    max-width: 700px;
    margin-bottom: 1.5rem;
  }

  .skill-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    text-decoration: none;
  }

  .meta-item:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .meta-icon {
    font-size: 1.25rem;
  }

  .license-badge {
    cursor: default;
  }

  .license-badge:hover {
    color: var(--color-text-secondary);
  }

  /* Source Tag */
  .source-tag {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .source-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .source-link:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text);
    text-decoration: none;
  }

  .source-link svg {
    flex-shrink: 0;
  }

  .view-source-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .view-source-link:hover {
    color: var(--color-accent);
    text-decoration: none;
  }

  .view-source-link svg {
    flex-shrink: 0;
  }

  .skill-content {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 300px;
    gap: 3rem;
    max-width: 100%;
  }

  .main-content {
    min-width: 0;
    max-width: 100%;
    overflow: hidden;
  }

  .content-section {
    margin-bottom: 2.5rem;
  }

  .content-section h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    margin-bottom: 1.25rem;
  }

  .content-section h2 svg {
    color: var(--color-accent);
  }

  /* Installation Section */
  .install-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
  }

  .install-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .install-info p {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
  }

  .install-path {
    font-size: 1rem;
    padding: 0.5rem 1rem;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
  }

  .install-actions {
    display: flex;
    gap: 0.75rem;
  }

  .download-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .download-btn:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }

  .download-btn.downloading {
    opacity: 0.7;
    cursor: wait;
  }

  .copy-all-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--color-bg-tertiary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .copy-all-btn:hover {
    background: var(--color-bg-secondary);
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  .copy-all-btn.copied {
    background: var(--color-success);
    border-color: var(--color-success);
    color: white;
  }

  .install-note {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
  }

  .install-note svg {
    flex-shrink: 0;
    margin-top: 0.125rem;
    color: var(--color-accent);
  }

  .install-note p {
    margin: 0;
  }

  /* Files Section */
  .file-tree {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .file-group {
    border-bottom: 1px solid var(--color-border);
  }

  .file-group:last-child {
    border-bottom: none;
  }

  .folder-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-bg-tertiary);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .folder-header svg {
    color: var(--color-accent);
  }

  .file-item {
    border-bottom: 1px solid var(--color-border);
  }

  .file-item:last-child {
    border-bottom: none;
  }

  .file-item summary {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background 0.15s ease;
    list-style: none;
  }

  .file-item summary::-webkit-details-marker {
    display: none;
  }

  .file-item summary:hover {
    background: var(--color-bg-tertiary);
  }

  .file-item[open] summary {
    background: var(--color-bg-tertiary);
    border-bottom: 1px solid var(--color-border);
  }

  .file-item summary svg {
    flex-shrink: 0;
    color: var(--color-text-secondary);
  }

  .file-name {
    flex: 1;
  }

  .file-size {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin-right: 0.5rem;
  }

  .copy-file-btn {
    padding: 0.375rem;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--color-text-secondary);
    transition: all 0.15s ease;
    opacity: 0;
  }

  .file-item summary:hover .copy-file-btn {
    opacity: 1;
  }

  .copy-file-btn:hover {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  .copy-file-btn.copied {
    background: var(--color-success);
    border-color: var(--color-success);
    color: white;
    opacity: 1;
  }

  .file-content {
    max-height: 400px;
    overflow: auto;
    width: 100%;
    box-sizing: border-box;
  }

  .file-content pre {
    margin: 0;
    border-radius: 0;
    font-size: 0.75rem;
    line-height: 1.5;
    overflow-x: auto;
    white-space: pre;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .file-content code {
    display: block;
    width: max-content;
    min-width: 100%;
  }

  .file-tree {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    max-width: 100%;
    width: 100%;
  }

  .files-section {
    max-width: 100%;
    overflow: hidden;
  }

  /* Syntax Highlighting */
  .file-content code.language-python { color: #3572A5; }
  .file-content code.language-javascript { color: #f1e05a; }
  .file-content code.language-typescript { color: #3178c6; }
  .file-content code.language-json { color: #292929; }
  .file-content code.language-yaml { color: #cb171e; }
  .file-content code.language-markdown { color: #083fa1; }
  .file-content code.language-bash { color: #89e051; }
  .file-content code.language-css { color: #563d7c; }
  .file-content code.language-html { color: #e34c26; }

  /* Dark mode-friendly syntax colors */
  :root {
    --syntax-python: #8be9fd;
    --syntax-javascript: #f1fa8c;
    --syntax-typescript: #66d9ef;
    --syntax-json: #a6e22e;
    --syntax-yaml: #f92672;
    --syntax-markdown: #bd93f9;
    --syntax-bash: #50fa7b;
    --syntax-css: #ff79c6;
    --syntax-html: #ffb86c;
    --syntax-text: var(--color-text);
  }

  @media (prefers-color-scheme: dark) {
    .file-content code.language-python { color: var(--syntax-python); }
    .file-content code.language-javascript { color: var(--syntax-javascript); }
    .file-content code.language-typescript { color: var(--syntax-typescript); }
    .file-content code.language-json { color: var(--syntax-json); }
    .file-content code.language-yaml { color: var(--syntax-yaml); }
    .file-content code.language-markdown { color: var(--syntax-markdown); }
    .file-content code.language-bash { color: var(--syntax-bash); }
    .file-content code.language-css { color: var(--syntax-css); }
    .file-content code.language-html { color: var(--syntax-html); }
  }

  .file-content code.language-text { color: var(--color-text); }

  /* File type indicators */
  .file-item[data-path$=".py"] summary svg { color: #3572A5; }
  .file-item[data-path$=".js"] summary svg { color: #f1e05a; }
  .file-item[data-path$=".ts"] summary svg { color: #3178c6; }
  .file-item[data-path$=".json"] summary svg { color: #292929; }
  .file-item[data-path$=".yaml"] summary svg,
  .file-item[data-path$=".yml"] summary svg { color: #cb171e; }
  .file-item[data-path$=".md"] summary svg { color: #083fa1; }
  .file-item[data-path$=".sh"] summary svg { color: #89e051; }
  .file-item[data-path$=".css"] summary svg { color: #563d7c; }
  .file-item[data-path$=".html"] summary svg { color: #e34c26; }

  /* Sidebar */
  .sidebar-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .sidebar-card h3 {
    font-size: 1rem;
    margin-bottom: 1rem;
  }

  .info-list {
    display: grid;
    gap: 0.75rem;
  }

  .info-list dt {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .info-list dd {
    font-size: 0.875rem;
  }

  .capitalize {
    text-transform: capitalize;
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    padding: 0.25rem 0.75rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .related-list {
    list-style: none;
    margin-top: 0.75rem;
  }

  .related-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .related-list li:last-child {
    border-bottom: none;
  }

  .related-list a {
    font-size: 0.875rem;
  }

  @media (max-width: 900px) {
    .skill-content {
      grid-template-columns: 1fr;
    }

    .sidebar {
      order: -1;
    }

    .install-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .copy-all-btn {
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 640px) {
    .skill-title-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .skill-title-row h1 {
      font-size: 1.75rem;
    }

    .copy-file-btn {
      opacity: 1;
    }
  }
</style>

<script define:vars={{ skillFiles: skill.files, skillPath }}>
  // Store file contents globally for copy functionality
  window.__skillFiles = skillFiles;
  window.__skillPath = skillPath;
  // Create a lookup map by path for quick access
  window.__filesByPath = {};
  skillFiles.forEach(f => {
    window.__filesByPath[f.path] = f.content;
  });
</script>

<script>
  // Copy all files button
  const copyAllBtn = document.getElementById('copy-all-btn');
  if (copyAllBtn) {
    copyAllBtn.addEventListener('click', async () => {
      const skillPath = (window as any).__skillPath;
      const files = (window as any).__skillFiles;
      
      if (!files || !files.length) {
        console.error('No files found');
        return;
      }
      
      // Create a formatted output for copying
      const output = files.map((f: any) => 
        `// ${skillPath}/${f.path}\n${f.content}`
      ).join('\n\n---\n\n');
      
      await copyToClipboard(output, copyAllBtn, 'Copy Contents');
    });
  }

  // Individual file copy buttons
  document.querySelectorAll('.copy-file-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const filePath = (btn as HTMLButtonElement).dataset.path;
      const filesByPath = (window as any).__filesByPath;
      const content = filesByPath[filePath || ''] || '';
      
      if (!content) {
        console.error('No content found for path:', filePath);
        return;
      }
      
      await copyToClipboard(content, btn);
    });
  });

  async function copyToClipboard(text: string, btn: Element, resetText?: string) {
    try {
      await navigator.clipboard.writeText(text);
      showCopiedFeedback(btn, resetText);
    } catch (err) {
      // Fallback for browsers without clipboard API or when not in secure context
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.cssText = 'position:fixed;opacity:0;pointer-events:none;';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        if (success) {
          showCopiedFeedback(btn, resetText);
        } else {
          console.error('execCommand copy failed');
        }
      } catch (fallbackErr) {
        console.error('All copy methods failed:', fallbackErr);
      }
    }
  }

  function showCopiedFeedback(btn: Element, resetText?: string) {
    btn.classList.add('copied');
    const span = btn.querySelector('span');
    if (span && resetText) {
      span.textContent = 'Copied!';
    }
    
    setTimeout(() => {
      btn.classList.remove('copied');
      if (span && resetText) {
        span.textContent = resetText;
      }
    }, 2000);
  }

  // Download ZIP functionality
  const downloadBtn = document.getElementById('download-btn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      const skillPath = (window as any).__skillPath;
      const files = (window as any).__skillFiles;
      
      if (!files || !files.length) {
        console.error('No files found');
        return;
      }
      
      downloadBtn.classList.add('downloading');
      const span = downloadBtn.querySelector('span');
      if (span) span.textContent = 'Creating ZIP...';
      
      try {
        // Dynamically load JSZip
        const JSZip = await loadJSZip();
        const zip = new JSZip();
        
        // Get skill name from path (e.g., "anthropics-skills/some-skill" -> "some-skill")
        const skillName = skillPath.split('/').pop() || 'skill';
        
        // Add files to ZIP with folder structure
        files.forEach((f: any) => {
          zip.file(`${skillName}/${f.path}`, f.content);
        });
        
        // Generate and download
        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${skillName}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        if (span) span.textContent = 'Downloaded!';
        setTimeout(() => {
          downloadBtn.classList.remove('downloading');
          if (span) span.textContent = 'Download ZIP';
        }, 2000);
      } catch (err) {
        console.error('Download failed:', err);
        if (span) span.textContent = 'Download Failed';
        setTimeout(() => {
          downloadBtn.classList.remove('downloading');
          if (span) span.textContent = 'Download ZIP';
        }, 2000);
      }
    });
  }

  // Dynamically load JSZip library
  function loadJSZip(): Promise<any> {
    return new Promise((resolve, reject) => {
      if ((window as any).JSZip) {
        resolve((window as any).JSZip);
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
      script.onload = () => resolve((window as any).JSZip);
      script.onerror = () => reject(new Error('Failed to load JSZip'));
      document.head.appendChild(script);
    });
  }
</script>
